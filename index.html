import React, { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Gift, Sparkles, BookOpen, Heart, Star, Lock, Instagram, Globe, ShoppingBag, Volume2, VolumeX, X } from 'lucide-react';
import confetti from 'canvas-confetti';

// --- DATA & CONTENT ---
const BRANDING = {
  main: "Miriam Lara",
  sub: "Silencem",
  web: "miriamlara.es",
  shop: "silencem.com",
  instagram: "@miriamlara",
  primaryColor: "#B76E79", // Rose Gold
  secondaryColor: "#1A1A1A"
};

const DAYS_DATA = [
  { day: 1, type: 'mindset', title: 'Intención', text: 'Cierra los ojos. Antes de empezar, ¿qué palabra define cómo quieres sentirte al terminar este año?', icon: <Sparkles /> },
  { day: 2, type: 'gift', title: 'Regalo: Lectura', text: 'Para nutrir tu mente, prueba 30 días de lectura ilimitada gratis.', action: 'Canjear Kindle Unlimited', link: 'https://amazon.es', icon: <BookOpen /> },
  { day: 3, type: 'action', title: 'Desconexión', text: 'Hoy, pon el móvil en modo avión 1 hora antes de dormir. Tu paz es innegociable.', icon: <VolumeX /> },
  { day: 4, type: 'reflection', title: 'Balance 2024', text: '¿Qué es lo mejor que te ha pasado este año que no habías planeado?', icon: <Heart /> },
  { day: 5, type: 'promo', title: 'Agenda Silencem', text: 'Organiza tu 2026 con propósito. Tienes un 15% de descuento exclusivo.', action: 'Ver Agenda', link: 'https://silencem.com', code: 'ADV2025', icon: <ShoppingBag /> },
  { day: 6, type: 'mindset', title: 'Gratitud', text: 'Escribe 3 cosas simples por las que agradeces hoy (un café, el sol, una sonrisa).', icon: <Star /> },
  { day: 7, type: 'gift', title: 'Playlist Focus', text: 'Música diseñada para trabajar en tus metas sin distracciones.', action: 'Escuchar en Spotify', link: '#', icon: <Volume2 /> },
  { day: 8, type: 'reflection', title: 'Soltar', text: '¿Qué hábito te está drenando energía y estás lista para dejar ir?', icon: <X /> },
  { day: 9, type: 'action', title: 'Micro-lujo', text: 'Hoy date un pequeño lujo: ese té especial, una mascarilla o 10 min de silencio.', icon: <Gift /> },
  { day: 10, type: 'promo', title: 'Kit Escritura', text: 'Las mejores herramientas para plasmar tus ideas. Pack de bolígrafos premium.', action: 'Ver en Amazon', link: 'https://amazon.es', icon: <ShoppingBag /> },
  { day: 11, type: 'mindset', title: 'Visualización', text: 'Imagina tu versión de enero 2026. ¿Cómo viste? ¿De qué habla? Siéntelo.', icon: <Sparkles /> },
  { day: 12, type: 'reflection', title: 'Logros', text: 'Celebra una victoria pequeña de esta semana. No hay logro insignificante.', icon: <Star /> },
  { day: 13, type: 'gift', title: 'Audible Free', text: 'Escucha tus mentores mientras caminas. 1 mes de prueba gratis.', action: 'Probar Audible', link: 'https://amazon.es', icon: <Volume2 /> },
  { day: 14, type: 'action', title: 'Orden', text: 'El orden externo trae calma interna. Organiza hoy solo un cajón o tu escritorio.', icon: <BookOpen /> },
  { day: 15, type: 'promo', title: 'Curso Metas', text: 'Masterclass exclusiva: "Diseña tu año ideal". Acceso anticipado.', action: 'Inscribirse', link: 'https://miriamlara.es', icon: <Globe /> },
  { day: 16, type: 'reflection', title: 'Energía', text: '¿Quiénes son las 3 personas que más te inspiran actualmente?', icon: <Heart /> },
  { day: 17, type: 'mindset', title: 'Afirmación', text: 'Repite conmigo: "Merezco el éxito y la abundancia que estoy creando".', icon: <Sparkles /> },
  { day: 18, type: 'gift', title: 'Wallpaper', text: 'Un fondo de pantalla minimalista para recordarte tu foco.', action: 'Descargar', link: '#', icon: <Instagram /> },
  { day: 19, type: 'action', title: 'Conexión', text: 'Escribe a esa amiga que hace mucho que no ves. Cultiva tus relaciones.', icon: <Heart /> },
  { day: 20, type: 'promo', title: 'Pack Regalo', text: '¿Buscas regalo? Pack Silencem con envoltorio especial incluido.', action: 'Comprar Regalo', link: 'https://silencem.com', icon: <Gift /> },
  { day: 21, type: 'reflection', title: 'Miedos', text: '¿Qué harías si supieras que no vas a fallar?', icon: <Star /> },
  { day: 22, type: 'mindset', title: 'Descanso', text: 'La productividad también es descansar. Hoy permítete no hacer nada productivo por 1h.', icon: <VolumeX /> },
  { day: 23, type: 'action', title: 'Carta Futura', text: 'Escribe una carta a tu yo del próximo diciembre. Guárdala.', icon: <BookOpen /> },
  { day: 24, type: 'promo', title: 'GRAN FINAL', text: '¡Feliz Navidad! Tienes un 30% en TODO para empezar tu mejor año.', action: 'CANJEAR AHORA', link: 'https://silencem.com', code: 'NAVIDAD30', icon: <Gift /> },
];

// --- SOUND UTILS (Web Audio API - No assets needed) ---
const playSound = (type) => {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.connect(gain);
    gain.connect(ctx.destination);

    const now = ctx.currentTime;

    if (type === 'pop') {
      osc.type = 'sine';
      osc.frequency.setValueAtTime(800, now);
      osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
      gain.gain.setValueAtTime(0.5, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
      osc.start(now);
      osc.stop(now + 0.1);
    } else if (type === 'jingle') {
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(440, now); // A4
      osc.frequency.setValueAtTime(554, now + 0.1); // C#5
      osc.frequency.setValueAtTime(659, now + 0.2); // E5
      gain.gain.setValueAtTime(0.1, now);
      gain.gain.linearRampToValueAtTime(0, now + 0.6);
      osc.start(now);
      osc.stop(now + 0.6);
    } else if (type === 'rip') {
      // White noise buffer for rip effect
      const bufferSize = ctx.sampleRate * 0.2; // 200ms
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
      }
      const noise = ctx.createBufferSource();
      noise.buffer = buffer;
      const noiseGain = ctx.createGain();
      noiseGain.gain.setValueAtTime(0.3, now);
      noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
      noise.connect(noiseGain);
      noiseGain.connect(ctx.destination);
      noise.start(now);
    }
  } catch (e) {
    console.error("Audio error", e);
  }
};

// --- COMPONENTS ---

const Header = () => (
  <header className="flex flex-col items-center justify-center py-6 px-4 bg-gradient-to-b from-[#1a1a1a] to-[#2d2d2d] text-white shadow-lg sticky top-0 z-30">
    <motion.div 
      initial={{ y: -20, opacity: 0 }} 
      animate={{ y: 0, opacity: 1 }}
      className="text-center"
    >
      <h2 className="text-xs uppercase tracking-[0.3em] text-[#B76E79] font-semibold mb-1">{BRANDING.sub}</h2>
      <h1 className="text-2xl font-serif tracking-widest">{BRANDING.main}</h1>
    </motion.div>
  </header>
);

const DayCard = ({ dayData, isLocked, isOpened, onOpen }) => {
  return (
    <motion.div
      layout
      whileHover={!isLocked && !isOpened ? { scale: 1.05 } : {}}
      whileTap={!isLocked && !isOpened ? { scale: 0.95 } : {}}
      onClick={() => !isLocked && onOpen(dayData)}
      className={`
        relative aspect-square rounded-lg shadow-md cursor-pointer overflow-hidden transform transition-all duration-300
        ${isLocked ? 'bg-gray-800 opacity-70 cursor-not-allowed' : 'cursor-pointer'}
        ${isOpened ? 'bg-[#B76E79]/10 border border-[#B76E79]/30' : 'bg-white'}
      `}
    >
      {/* Front of the Card (The Cover) */}
      <AnimatePresence>
        {!isOpened && (
          <motion.div
            initial={{ opacity: 1 }}
            exit={{ 
              opacity: 0, 
              scale: 1.5, 
              rotate: 15,
              transition: { duration: 0.5 }
            }}
            className={`
              absolute inset-0 flex flex-col items-center justify-center z-10
              bg-gradient-to-br ${isLocked ? 'from-gray-700 to-gray-800' : 'from-[#B76E79] to-[#965A63]'}
            `}
          >
            {isLocked ? (
              <Lock className="w-6 h-6 text-gray-400 mb-1" />
            ) : (
              <span className="text-xs text-white/60 uppercase tracking-widest mb-1">Día</span>
            )}
            <span className={`text-3xl font-serif font-bold ${isLocked ? 'text-gray-500' : 'text-white'}`}>
              {dayData.day}
            </span>
            {!isLocked && (
              <motion.div 
                animate={{ rotate: [0, 5, -5, 0] }}
                transition={{ repeat: Infinity, duration: 4, delay: Math.random() }}
                className="absolute bottom-2 right-2 opacity-50"
              >
                <Sparkles className="w-4 h-4 text-yellow-200" />
              </motion.div>
            )}
            
            {/* Texture overlay for paper effect */}
            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')] opacity-20 mix-blend-overlay"></div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Back of the Card (Revealed State - Preview) */}
      <div className="absolute inset-0 flex flex-col items-center justify-center p-2 text-center z-0">
        <div className="text-[#B76E79] mb-1 opacity-50">
          {dayData.icon}
        </div>
        <p className="text-[10px] uppercase tracking-wide text-gray-500 font-bold">Abierto</p>
      </div>
    </motion.div>
  );
};

const Modal = ({ isOpen, onClose, data }) => {
  if (!isOpen || !data) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <motion.div 
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        onClick={onClose}
        className="absolute inset-0 bg-black/80 backdrop-blur-sm"
      />
      
      <motion.div
        initial={{ scale: 0.8, opacity: 0, y: 50 }}
        animate={{ scale: 1, opacity: 1, y: 0 }}
        exit={{ scale: 0.8, opacity: 0, y: 50 }}
        className="relative w-full max-w-md bg-white rounded-xl overflow-hidden shadow-2xl z-10"
      >
        {/* Decorative Top */}
        <div className="h-2 bg-gradient-to-r from-[#B76E79] to-[#D4AF37]" />
        
        <button 
          onClick={onClose}
          className="absolute top-4 right-4 p-2 bg-gray-100 hover:bg-gray-200 rounded-full transition-colors z-20"
        >
          <X className="w-5 h-5 text-gray-600" />
        </button>

        <div className="p-8 text-center flex flex-col items-center">
          <motion.div 
            initial={{ scale: 0, rotate: -180 }}
            animate={{ scale: 1, rotate: 0 }}
            transition={{ type: "spring", damping: 12 }}
            className="w-20 h-20 rounded-full bg-[#B76E79]/10 flex items-center justify-center mb-6 text-[#B76E79]"
          >
            {React.cloneElement(data.icon, { size: 40 })}
          </motion.div>

          <h3 className="text-sm font-bold text-[#B76E79] uppercase tracking-widest mb-2">
             Día {data.day} • {data.type === 'promo' || data.type === 'gift' ? 'Regalo' : 'Bienestar'}
          </h3>
          
          <h2 className="text-3xl font-serif text-gray-900 mb-4 leading-tight">
            {data.title}
          </h2>

          <div className="w-16 h-1 bg-gray-200 mb-6 rounded-full" />

          <p className="text-gray-600 text-lg leading-relaxed mb-8">
            {data.text}
          </p>

          {data.code && (
            <div className="bg-gray-100 px-6 py-3 rounded-lg border border-dashed border-gray-400 mb-6 cursor-pointer hover:bg-gray-200" onClick={() => {navigator.clipboard.writeText(data.code); playSound('pop')}}>
              <span className="text-xs text-gray-500 block mb-1">Código descuento:</span>
              <span className="text-xl font-mono font-bold tracking-wider text-[#B76E79]">{data.code}</span>
            </div>
          )}

          {data.action && (
            <motion.a
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              href={data.link}
              target="_blank"
              rel="noopener noreferrer"
              className="w-full py-4 bg-[#1A1A1A] text-white text-lg rounded-lg font-semibold hover:bg-[#333] transition-all shadow-lg flex items-center justify-center gap-2"
            >
              {data.action} <Sparkles size={18} />
            </motion.a>
          )}

          {data.type === 'reflection' && (
            <div className="mt-4 p-4 bg-[#FAF9F6] rounded-lg border border-[#B76E79]/20 w-full text-left">
              <p className="text-sm italic text-gray-500">
                "Tómate 5 minutos para escribir esto en tu agenda o notas."
              </p>
            </div>
          )}
        </div>
      </motion.div>
    </div>
  );
};

export default function AdventCalendar() {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [openedDoors, setOpenedDoors] = useState([]);
  const [selectedDay, setSelectedDay] = useState(null);
  const [cheatMode, setCheatMode] = useState(false); // For demo purposes

  // Load state from local storage
  useEffect(() => {
    const saved = localStorage.getItem('silencem_advent_state');
    if (saved) {
      setOpenedDoors(JSON.parse(saved));
    }
  }, []);

  // Save state
  useEffect(() => {
    localStorage.setItem('silencem_advent_state', JSON.stringify(openedDoors));
  }, [openedDoors]);

  const currentDayNum = cheatMode ? 25 : currentDate.getDate();
  // Ensure we only care about Dec logic if we are strictly following dates, 
  // but for this demo, we assume the app is active.

  const handleOpenDoor = (dayData) => {
    playSound('rip');
    
    // Simulate "tearing" delay
    setTimeout(() => {
      playSound('jingle');
      
      // Fire confetti
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 },
        colors: ['#B76E79', '#D4AF37', '#ffffff']
      });

      if (!openedDoors.includes(dayData.day)) {
        setOpenedDoors([...openedDoors, dayData.day]);
      }
      setSelectedDay(dayData);
    }, 400);
  };

  const isLocked = (day) => {
    if (cheatMode) return false;
    // In a real scenario check month === 11 (December)
    return day > currentDayNum;
  };

  return (
    <div className="min-h-screen bg-[#FDFBF7] text-gray-800 font-sans pb-20">
      <Header />

      {/* Controls for Demo */}
      <div className="flex justify-center gap-4 py-4 px-4 bg-[#FAF9F6] border-b border-gray-200">
        <label className="flex items-center gap-2 text-xs text-gray-500 cursor-pointer">
          <input 
            type="checkbox" 
            checked={cheatMode} 
            onChange={(e) => setCheatMode(e.target.checked)}
            className="rounded text-[#B76E79] focus:ring-[#B76E79]"
          />
          Modo Demo (Desbloquear todo)
        </label>
        <button 
          onClick={() => {setOpenedDoors([]); localStorage.removeItem('silencem_advent_state');}}
          className="text-xs text-red-400 hover:text-red-600 underline"
        >
          Resetear Progreso
        </button>
      </div>

      <main className="max-w-4xl mx-auto p-4 sm:p-8">
        <div className="mb-8 text-center">
          <p className="text-[#B76E79] font-medium tracking-wide text-sm mb-2">CALENDARIO DE ADVIENTO 2025</p>
          <h2 className="text-3xl md:text-4xl font-serif text-gray-900 leading-tight">
            Cierra ciclos, <br/><span className="italic text-[#B76E79]">abre caminos.</span>
          </h2>
        </div>

        {/* Grid */}
        <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 sm:gap-4 md:gap-6">
          {DAYS_DATA.map((data) => (
            <DayCard
              key={data.day}
              dayData={data}
              isLocked={isLocked(data.day)}
              isOpened={openedDoors.includes(data.day)}
              onOpen={handleOpenDoor}
            />
          ))}
        </div>
      </main>

      <footer className="mt-12 bg-[#1A1A1A] text-white py-12 px-4">
        <div className="max-w-md mx-auto text-center space-y-6">
          <div className="flex justify-center gap-6 text-[#B76E79]">
            <Instagram className="cursor-pointer hover:text-white transition-colors" />
            <Globe className="cursor-pointer hover:text-white transition-colors" />
            <ShoppingBag className="cursor-pointer hover:text-white transition-colors" />
          </div>
          <div className="h-px bg-gray-800 w-full" />
          <div className="space-y-2">
            <p className="font-serif text-xl">{BRANDING.main}</p>
            <p className="text-xs text-gray-500 tracking-widest uppercase">{BRANDING.sub} • AGENDA METAS 2026</p>
          </div>
          <p className="text-[10px] text-gray-600 mt-8">
            © 2025 Miriam Lara. Diseñado para tu bienestar.
          </p>
        </div>
      </footer>

      <AnimatePresence>
        {selectedDay && (
          <Modal 
            isOpen={!!selectedDay} 
            data={selectedDay} 
            onClose={() => setSelectedDay(null)} 
          />
        )}
      </AnimatePresence>
      
      {/* Floating Action for Agenda if not bought */}
      <motion.div 
        initial={{ y: 100 }}
        animate={{ y: 0 }}
        className="fixed bottom-4 left-4 right-4 md:left-auto md:right-8 md:w-80 bg-white p-4 rounded-lg shadow-2xl border-l-4 border-[#B76E79] flex items-center justify-between z-40"
      >
        <div>
          <p className="text-xs font-bold text-gray-400 uppercase">Silencem</p>
          <p className="text-sm font-semibold text-gray-800">¿Ya tienes tu Agenda 2026?</p>
        </div>
        <a href="https://silencem.com" target="_blank" className="bg-[#1A1A1A] text-white text-xs px-4 py-2 rounded font-medium hover:bg-[#B76E79] transition-colors">
          Ver Tienda
        </a>
      </motion.div>
    </div>
  );
}
